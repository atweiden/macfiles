#
# ----------------------------------------------------------
# General Options
# ----------------------------------------------------------
#

# Time after which the -r (repeat) in bind -r expires.
set -g repeat-time 300

# Unbind keys.
unbind C-b
unbind C-s
unbind c
unbind '"'
unbind %
unbind s

# Screen prefix key.
set -g prefix C-a
bind a send-prefix

# Vim keys.
setw -g xterm-keys on
setw -g mode-keys vi
set -sg escape-time 0

# Set default shell to Homebrew Bash.
set -g default-shell /usr/local/bin/bash
set -g default-command "/usr/local/bin/bash"

# Set default TERM.
set -g default-terminal tmux

# Update TERM when creating new session or attaching to existing session.
set -g update-environment "DISPLAY SSH_ASKPASS SSH_AGENT_PID SSH_CONNECTION WINDOWID XAUTHORITY TERM"

# Inform programs of 256 color support when available.
if "[[ ${TERM} =~ 256color || ${TERM} == fbterm ]]" "set -g default-terminal tmux-256color"

# Enable mouse.
set -g mouse on

# Scroll back buffer n lines.
set -g history-limit 100000

# Make scrolling work as expected.
set -ga terminal-overrides ',*256color*:xterm*:smcup@:rmcup@'

# Add True Color support.
set -ga terminal-overrides ',*256color*:Tc'

# Reload config without killing server.
bind R source-file ~/.tmux.conf \; display-message "Config reloaded..."


#
# ----------------------------------------------------------
# Windows and Panes
# ----------------------------------------------------------
#

# Start window indexing at one instead of zero.
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows if they get out of order.
set -g renumber-windows on

# Don't aggressively resize windows.
setw -g aggressive-resize off

# Don't allow running programs to change the window name.
setw -g allow-rename off

# Don't wrap searches around the end of the pane contents.
setw -g wrap-search off

# Toggle maximize pane on <C-A><C-A>.
bind C-a resize-pane -Z

# Open new windows with current path.
bind c new-window -c "#{pane_current_path}"

# URxvt tab-like window switching.
bind -n S-down new-window -c "#{pane_current_path}"
bind -n S-left previous-window
bind -n S-right next-window
bind -n C-left swap-window -t -1
bind -n C-right swap-window -t +1
bind -T copy-mode-vi S-down new-window -c "#{pane_current_path}"
bind -T copy-mode-vi S-left previous-window
bind -T copy-mode-vi S-right next-window
bind -T copy-mode-vi C-left swap-window -t -1
bind -T copy-mode-vi C-right swap-window -t +1

# URxvt tab-like window renaming.
bind -n S-up command-prompt -p "rename window to:" "rename-window '%%'"
bind -T copy-mode-vi S-up command-prompt -p "rename window to:" "rename-window '%%'"

# Allow repeats for next/prev window.
bind -r n next-window
bind -r p previous-window

# Vim-like window splitting.
bind v split-window -h -c "#{pane_current_path}"
bind s split-window -c "#{pane_current_path}"

# Vim-like pane resize.
bind -r 'k' resize-pane -U 1
bind -r 'j' resize-pane -D 1
bind -r 'h' resize-pane -L 1
bind -r 'l' resize-pane -R 1

# Smart pane switching with awareness of Vim splits.
# See: https://github.com/christoomey/vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind -n C-h if-shell "$is_vim" "send-keys C-h"  "select-pane -L"
bind -n C-j if-shell "$is_vim" "send-keys C-j"  "select-pane -D"
bind -n C-k if-shell "$is_vim" "send-keys C-k"  "select-pane -U"
bind -n C-l if-shell "$is_vim" "send-keys C-l"  "select-pane -R"
bind -n C-\ if-shell "$is_vim" "send-keys C-\\" "select-pane -l"
bind -T copy-mode-vi C-h select-pane -L
bind -T copy-mode-vi C-j select-pane -D
bind -T copy-mode-vi C-k select-pane -U
bind -T copy-mode-vi C-l select-pane -R
bind -T copy-mode-vi C-\ select-pane -l

# Join and break panes.
bind J command-prompt -p "join pane from:"  "join-pane -s '%%'"
bind S command-prompt -p "send pane to:"  "join-pane -t '%%'"
bind B break-pane       # move pane to new window and switch to it
bind D break-pane -d    # move pane to new window in the background

# Synchronize panes.
bind * setw synchronize-pane

# Select pane with fzf.
bind 0 run "tmux split-window -p 40 'bash -ci ftpane'"


#
# ----------------------------------------------------------
# Copy/paste
# ----------------------------------------------------------
#

bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi V send -X select-line
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y send -X copy-pipe "pbcopy"
bind -T copy-mode-vi H send -X start-of-line
bind -T copy-mode-vi L send -X end-of-line

# Make single-click cancel a selection.
bind -T copy-mode-vi MouseDown1Pane select-pane \; send -X clear-selection

# Make double-click select a word.
bind -T root DoubleClick1Pane select-pane \; copy-mode \; send-keys -X select-word

# Preserve mouse selection and scroll position after mouse drag.
unbind -T copy-mode-vi MouseDragEnd1Pane

# Make mouse scroll clear selection.
bind -T copy-mode-vi WheelUpPane   select-pane \; send -X clear-selection \; send -N5 -X scroll-up
bind -T copy-mode-vi WheelDownPane select-pane \; send -X clear-selection \; send -N5 -X scroll-down


#
# ----------------------------------------------------------
# Terminal Title
# ----------------------------------------------------------
#

# Enable terminal window titles.
set -g set-titles on

# Set terminal title format.
set -g set-titles-string "#{session_name} Â» #{window_name}"

# Don't automatically rename terminal title.
setw -g automatic-rename off


#
# ----------------------------------------------------------
# Status Bar
# ----------------------------------------------------------
#

# Place status bar on top of screen.
set -g status-position top

# Use key map for the status bar.
set -g status-keys vi

# List activity on all windows.
set -g bell-action any

# Set window notifications.
setw -g monitor-activity on
setw -g window-status-activity-attr none
set -g visual-activity off

# Update the status bar every n seconds.
set -g status-interval 5

# On-screen time for display-panes in ms.
set -g display-time 2000

# Use 24-hour time.
setw -g clock-mode-style 24

# Statusbar theme.
source ~/.tmux/seoul256-powerline.tmux
